/* Search Pro v3.1 - Last Update on 10/31/2025 - Race Condition Fix */
class ControlPanelCore{constructor(){this.config=this.getDefaultConfig(),this.currentTab="general",this.isLoading=!1,this.toastTimeout=null,this.previewTimeout=null,this.maxConfigSize=1048576,this.maxStringLength=1e4,this.tabHandlers=new Map}registerTabHandler(e,t){this.tabHandlers.set(e,t),t.setCore(this)}getTabHandler(e){return this.tabHandlers.get(e)}sanitizeInput(e,t=null){if("string"!=typeof e)return String(e||"");const o=document.createElement("div");o.textContent=e;const n=o.innerHTML,s=t||this.maxStringLength;return n.length>s?(console.warn("ðŸš¨ Security: Input truncated due to length limit"),n.substring(0,s)):n}isValidPropertyName(e){if("string"!=typeof e)return!1;const t=["__proto__","constructor","prototype","valueOf","toString","hasOwnProperty","isPrototypeOf","propertyIsEnumerable"],o=e.split(".");for(const e of o){if(t.includes(e))return console.warn(`ðŸš¨ Security: Blocked dangerous property: ${e}`),!1;if(e.startsWith("__"))return console.warn(`ðŸš¨ Security: Blocked dunder property: ${e}`),!1}return!0}validateConfigStructure(e){try{if(!e||"object"!=typeof e)return console.error("ðŸš¨ Security: Config is not a valid object"),!1;const t=["searchBar","appearance","content"];for(const o of t)o in e||console.warn(`âš ï¸ Missing required config property: ${o}`);const o=JSON.stringify(e);return o.length>this.maxConfigSize?(console.error(`ðŸš¨ Security: Config size exceeds limit: ${o.length} > ${this.maxConfigSize}`),!1):(console.log("âœ… Config structure validation passed"),!0)}catch(e){return console.error("ðŸš¨ Security: Config validation error:",e),!1}}isContentSafe(e){return"string"!=typeof e||![/<script[\s\S]*?>/i,/javascript:/i,/on\w+\s*=/i,/<iframe[\s\S]*?>/i,/<object[\s\S]*?>/i,/<embed[\s\S]*?>/i,/<form[\s\S]*?>/i,/eval\s*\(/i,/Function\s*\(/i].some(t=>t.test(e))}isThumbnailAssetField(e){return!("thumbnailSettings.defaultImagePath"!==e&&!/^thumbnailSettings\.defaultImages\./.test(e)&&"thumbnails.defaultPath"!==e&&!/^thumbnails\.defaults\./.test(e))}stripAssetPrefix(e){return e&&"string"==typeof e?e.replace(/^\.?\/?(?:search-pro-v3\/)?assets\//i,""):""}ensureAssetPrefix(e){if(!e||"string"!=typeof e)return"";const t=e.trim();if(/^(https?:)?\/\//i.test(t)||t.startsWith("/"))return t;const o=this.stripAssetPrefix(t);return o?`assets/${o}`:""}safeObjectMerge(e,t,o=10,n=0){if(n>o)return console.warn("ðŸš¨ Security: Object merge depth limit reached"),e;if(!t||"object"!=typeof t||Array.isArray(t))return e;const s={...e};for(const e in t){if("__proto__"===e||"constructor"===e||"prototype"===e||e.startsWith("__")){console.warn(`ðŸš¨ Security: Blocked dangerous property '${e}'`);continue}if(!this.isPropertyNameSafe(e)){console.warn(`ðŸš¨ Security: Blocked unsafe property name '${e}'`);continue}const r=t[e];r&&"object"==typeof r&&!Array.isArray(r)?s[e]=this.safeObjectMerge(s[e]||{},r,o,n+1):s[e]="string"==typeof r?this.sanitizeInput(r):r}return s}isPropertyNameSafe(e){return"string"==typeof e&&(!["__proto__","constructor","prototype","__defineGetter__","__defineSetter__","__lookupGetter__","__lookupSetter__","valueOf","toString"].includes(e)&&!e.startsWith("__")&&e.length<100)}safeSetNestedProperty(e,t,o){if(!e||"object"!=typeof e||"string"!=typeof t)return!1;const n=t.split(".");let s=e;for(let e=0;e<n.length-1;e++){const t=n[e];if(!this.isPropertyNameSafe(t))return console.warn(`ðŸš¨ Security: Blocked unsafe property in path: ${t}`),!1;t in s&&"object"==typeof s[t]||(s[t]={}),s=s[t]}const r=n[n.length-1];return this.isPropertyNameSafe(r)?(s[r]="string"==typeof o?this.sanitizeInput(o):o,!0):(console.warn(`ðŸš¨ Security: Blocked unsafe final property: ${r}`),!1)}safeLocalStorageSet(e,t){try{const o=this.sanitizeInput(e,100);let n;if("string"==typeof t)n=this.sanitizeInput(t);else if("object"==typeof t){const e=JSON.stringify(t);if(e.length>this.maxConfigSize)return console.warn("ðŸš¨ Security: Configuration too large for storage"),!1;n=e}else n=String(t);return localStorage.setItem(o,n),!0}catch(e){return console.error("ðŸš¨ Security: Error setting localStorage:",e),!1}}safeLocalStorageGet(e,t=null){try{const o=this.sanitizeInput(e,100),n=localStorage.getItem(o);if(null===n)return t;try{const e=JSON.parse(n);return"object"==typeof e&&null!==e?this.validateAndSanitizeConfig(e)?e:t:e}catch{return this.sanitizeInput(n)}}catch(e){return console.error("ðŸš¨ Security: Error getting localStorage:",e),t}}getNestedProperty(e,t){try{if(!e||"string"!=typeof t)return;return t.split(".").reduce((e,t)=>{if(this.isPropertyNameSafe(t))return e&&void 0!==e[t]?e[t]:void 0;console.warn(`ðŸš¨ Security: Unsafe property access: ${t}`)},e)}catch(e){return void console.error("ðŸš¨ Security: Error getting nested property:",e)}}setNestedProperty(e,t,o){return this.safeSetNestedProperty(e,t,o)}showToast(e,t,o,n=5e3){try{const s=this.sanitizeInput(e,20),r=this.sanitizeInput(t),a=this.sanitizeInput(o);if(window.toastManager&&"function"==typeof window.toastManager.showToast)return void window.toastManager.showToast(s,r,a,n);if(window.showToast&&"function"==typeof window.showToast)return void window.showToast(s,r,a,n);console.log(`ðŸž Toast: ${s.toUpperCase()} - ${r}: ${a}`)}catch(e){console.error("ðŸš¨ Security: Error showing toast:",e)}}setLoading(e,t="Loading..."){try{document.querySelectorAll(".btn:not(.modal-btn-confirm):not(.modal-btn-cancel), .fab-action").forEach(t=>{t.disabled=e,t.style.opacity=e?"0.6":"1"}),this.isLoading=e,e?console.log(`â³ Loading: ${t}`):console.log("âœ… Loading complete")}catch(e){console.error("ðŸš¨ Security: Error setting loading state:",e)}}validateAndSanitizeConfig(e){try{if(!e||"object"!=typeof e)return!1;const t=(e,o=10,n=0)=>{if(n>o||!e||"object"!=typeof e)return!1;for(const s in e)if(Object.prototype.hasOwnProperty.call(e,s)){if(!this.isPropertyNameSafe(s))return console.warn(`ðŸš¨ Security: Unsafe property name in config: ${s}`),!1;const r=e[s];if("string"==typeof r){if(!this.isContentSafe(r))return console.warn(`ðŸš¨ Security: Unsafe content in config property ${s}`),!1;e[s]=this.sanitizeInput(r)}else if(r&&"object"==typeof r&&!Array.isArray(r)&&!t(r,o,n+1))return!1}return!0};return t(e)}catch(e){return console.error("ðŸš¨ Security: Error validating and sanitizing config:",e),!1}}onFormChange(e){try{const t=this.sanitizeInput(e.name||e.id,100);let o="checkbox"===e.type?e.checked:e.value;if(this.config?.debugMode&&console.debug(`FORM CHANGE: ${t} -> ${o} (type: ${e.type})`),this.config?.debugMode&&t.includes("includePanoramas")&&console.debug("PANORAMA FORM DEBUG: toggle changed",{fieldName:t,newValue:o,inputType:e.type,inputChecked:e.checked,configBefore:this.config.includeContent?.elements?.includePanoramas}),"string"==typeof o&&(o=this.sanitizeInput(o),!this.isContentSafe(o)))return void console.warn("ðŸš¨ Security: Unsafe content detected in form input");if(["positionLeft","positionBottom"].includes(t)&&""===o&&(o=null),"number"===e.type&&""!==o&&null!==o){const e=parseFloat(o);if(isNaN(e))return void console.warn("ðŸš¨ Security: Invalid numeric value detected");o=e}if("range"===e.type&&""!==o){const e=parseFloat(o);if(isNaN(e))return void console.warn("ðŸš¨ Security: Invalid range value detected");o=e}if("string"==typeof o&&this.isThumbnailAssetField(t)&&(o=this.ensureAssetPrefix(o)),!this.safeSetNestedProperty(this.config,t,o))return void console.warn(`ðŸš¨ Security: Failed to set property ${t} safely`);this.validateField(e),clearTimeout(this.previewTimeout),this.previewTimeout=setTimeout(()=>{this.showLivePreview(t,o)},300),this.config?.debugMode&&console.debug(`CONFIG UPDATED: ${t} = ${o}`),this.config?.debugMode&&t.includes("includePanoramas")&&console.debug("PANORAMA CONFIG DEBUG: after update",{configAfter:this.config.includeContent?.elements?.includePanoramas,fullElementsConfig:this.config.includeContent?.elements})}catch(e){console.error("ðŸš¨ Security: Error handling form change:",e)}}onFormInput(e){try{this.validateField(e)}catch(e){console.error("ðŸš¨ Security: Error handling form input:",e)}}validateField(e){try{const t="checkbox"===e.type?e.checked:e.value,o=this.sanitizeInput(e.name||e.id,100);let n=!0;if(e.classList.remove("error","valid"),"string"!=typeof t||this.isContentSafe(t)||(n=!1,console.warn(`ðŸš¨ Security: Unsafe content in field ${o}`)),"number"===e.type){const o=parseFloat(e.min),s=parseFloat(e.max),r=parseFloat(t);(""!==t&&isNaN(r)||!isNaN(o)&&r<o||!isNaN(s)&&r>s)&&(n=!1)}if("color"===e.type&&t&&!/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(t)&&(n=!1),"range"===e.type){const o=parseFloat(e.min),s=parseFloat(e.max),r=parseFloat(t);(isNaN(r)||r<o||r>s)&&(n=!1)}return n?e.classList.add("valid"):e.classList.add("error"),n}catch(e){return console.error("ðŸš¨ Security: Error in field validation:",e),!1}}showLivePreview(e,t){try{const o=this.sanitizeInput(e,100),n=document.getElementById(o)||document.querySelector(`[name="${o}"]`);if(!n)return;const s=n.closest(".form-group");if(!s)return;if(s.classList.add("has-preview"),!s.querySelector(".live-preview-indicator")){const e=document.createElement("div");e.className="live-preview-indicator",e.setAttribute("aria-label","Live preview active"),s.style.position="relative",s.appendChild(e)}setTimeout(()=>{s.classList.remove("has-preview")},3e3),this.applyLivePreview(o,t),console.log(`ðŸ“± Live preview: ${o} = ${t}`)}catch(e){console.error("ðŸš¨ Security: Error showing live preview:",e)}}applyLivePreview(e,t){try{const o=JSON.parse(JSON.stringify(this.config));if(this.safeSetNestedProperty(o,e,t),e.includes("includePanoramas")&&console.log("ðŸ” PANORAMA DEBUG: Live preview config update",{fieldName:e,value:t,includeContentElements:o.includeContent?.elements,fullIncludeContent:o.includeContent}),this.safeLocalStorageSet("searchProLiveConfig",o),window.parent&&window.parent!==window)try{window.parent.postMessage({type:"searchProConfigPreview",config:o,field:this.sanitizeInput(e),value:"string"==typeof t?this.sanitizeInput(t):t},"*")}catch(e){console.warn("ðŸš¨ Security: Error posting message to parent:",e)}}catch(e){console.warn("ðŸš¨ Security: Live preview failed:",e)}}setupFormListeners(e=document){try{const t=e.querySelectorAll(".form-input, .toggle-input, .color-input, .range-input, .form-select"),o=e.querySelector("#includePanoramas");console.log("ðŸ” LISTENERS DEBUG: Found panorama toggle?",{panoramaToggle:o,hasToggleInputClass:o?.classList.contains("toggle-input"),panoramaName:o?.getAttribute("name"),panoramaId:o?.id,totalInputsFound:t.length}),t.forEach(e=>{e.addEventListener("change",()=>this.onFormChange(e)),e.addEventListener("input",()=>this.onFormInput(e)),"includePanoramas"===e.id&&console.log("ðŸ” LISTENERS DEBUG: Event listeners attached to panorama toggle",e)}),console.log(`âœ… Form listeners set up for ${t.length} inputs`)}catch(e){console.error("ðŸš¨ Security: Error setting up form listeners:",e)}}populateForm(e=document){try{e.querySelectorAll("[name]").forEach(e=>{const t=e.getAttribute("name");if(!t)return;const o=this.getNestedProperty(this.config,t);if(void 0!==o)if("checkbox"===e.type)e.checked=Boolean(o);else if("number"===e.type)e.value=null===o?"":String(o);else if("range"===e.type){e.value=null===o?"":String(o);const t=e.parentNode.querySelector(".range-value");t&&(t.textContent=String(o))}else if("color"===e.type){e.value=o||"#000000";const t=e.parentNode.querySelector(".color-hex");t&&(t.textContent=e.value.toLowerCase())}else if(e.multiple&&"select"===e.tagName.toLowerCase())Array.isArray(o)&&Array.from(e.options).forEach(e=>{e.selected=o.includes(e.value)});else if("searchBar.width"===t&&"number"==typeof o)e.value=o+"px";else if(Array.isArray(o)){const t=o.filter(e=>e&&e.toString().trim());e.value=t.length>0?t.join(", "):""}else{const n=null===o?"":String(o);e.value=this.isThumbnailAssetField(t)?this.stripAssetPrefix(n):n}}),console.log("ðŸ“ Form populated with current config securely")}catch(e){console.error("ðŸš¨ Security: Error populating form:",e)}}getDefaultConfig(){return{autoHide:{mobile:!1,desktop:!1},mobileBreakpoint:768,minSearchChars:2,minSearchLength:2,elementTriggering:{initialDelay:300,maxRetries:3,retryInterval:300,maxRetryInterval:1e3,baseRetryInterval:300},filter:{mode:"none",allowedValues:[],blacklistedValues:[],valueMatchMode:{whitelist:"exact",blacklist:"contains"},mediaIndexes:{mode:"none",allowed:[],blacklisted:[]},elementTypes:{mode:"none",allowedTypes:[],blacklistedTypes:[]},elementLabels:{mode:"none",allowedValues:[],blacklistedValues:[]},tagFiltering:{mode:"none",allowedTags:[],blacklistedTags:[]}},searchSettings:{debounce:300,maxResults:50,caseSensitive:!1,fuzzySearch:{enabled:!1,threshold:.3},highlightMatches:!0,fieldWeights:{label:1,businessName:.9,subtitle:.8,businessTag:1,tags:.6,parentLabel:.3},behavior:{threshold:.4,distance:40,minMatchCharLength:1,useExtendedSearch:!0,ignoreLocation:!0,includeScore:!0},boostValues:{businessMatch:2,sheetsMatch:2.5,labeledItem:1.5,unlabeledItem:1,childElement:.8}},displayLabels:{panoramas:"label",hotspots:"label",polygons:"label",videos:"label",images:"label",text:"label"},useAsLabel:{panoramas:"none",hotspots:"none",polygons:"none",videos:"none",images:"none",text:"none"},maxResults:20,debugMode:!1,showHotspots:!0,showMedia:!0,showPanoramas:!0,searchInHotspotTitles:!0,searchInMediaTitles:!0,searchInPanoramaTitles:!0,searchInHotspotDescriptions:!1,searchInMediaDescriptions:!1,searchBar:{placeholder:"Search... Type * for all",width:350,position:{top:70,right:70,left:null,bottom:null},useResponsive:!0,mobilePosition:{top:60,left:20,right:20,bottom:"auto"},mobileOverrides:{enabled:!0,breakpoint:768,width:"90%",maxWidth:350,visibility:{behavior:"dynamic",showOnScroll:!0,hideThreshold:100}}},appearance:{searchField:{borderRadius:{topLeft:35,topRight:35,bottomRight:35,bottomLeft:35},typography:{fontSize:"16px",fontFamily:"-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif",fontWeight:"400",fontStyle:"normal",lineHeight:"1.5",letterSpacing:"0px",textTransform:"none",placeholder:{fontSize:"16px",fontFamily:"-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif",fontWeight:"400",fontStyle:"italic",opacity:.7,letterSpacing:"0px",textTransform:"none"},focus:{fontSize:"16px",fontWeight:"400",letterSpacing:"0.25px"}}},searchResults:{borderRadius:{topLeft:5,topRight:5,bottomRight:5,bottomLeft:5}},colors:{searchBackground:"#f4f3f2",searchText:"#1a1a1a",placeholderText:"#94a3b8",searchIcon:"#94a3b8",clearIcon:"#94a3b8",resultsBackground:"#ffffff",groupHeaderBackground:"#ffffff",groupHeaderColor:"#20293A",groupCountColor:"#94a3b8",resultHover:"#f0f0f0",resultBorderLeft:"#ebebeb",resultText:"#1e293b",resultSubtitle:"#64748b",resultIconColor:"#6e85f7",resultSubtextColor:"#000000",tagBackground:"#e0f2fe",tagText:"#0369a1",tagBorder:"#0891b2",highlightBackground:"#ffff00",highlightBackgroundOpacity:.5,highlightText:"#000000",highlightWeight:"bold"},tags:{borderRadius:16,fontSize:"11px",padding:"3px 10px",margin:"2px",fontWeight:"600",textTransform:"uppercase",showBorder:!0,borderWidth:"1px"}},display:{showGroupHeaders:!0,showGroupCount:!0,showIconsInResults:!0,showTagsInResults:!0,showSubtitlesInResults:!0,showParentInfo:!0},thumbnailSettings:{enableThumbnails:!1,thumbnailSize:"48px",borderRadius:4,borderWidth:4,borderColor:"#9CBBFF",defaultImagePath:"assets/default-thumbnail.jpg",defaultImages:{Panorama:"assets/default-thumbnail.jpg",Hotspot:"assets/hotspot-default.jpg",Polygon:"assets/polygon-default.jpg",Video:"assets/video-default.jpg",Webframe:"assets/webframe-default.jpg",Image:"assets/image-default.jpg",Text:"assets/text-default.jpg",ProjectedImage:"assets/projected-image-default.jpg",Element:"assets/element-default.jpg",Business:"assets/business-default.jpg","3DModel":"assets/3d-model-default.jpg","3DHotspot":"assets/3d-hotspot-default.jpg","3DModelObject":"assets/3d-model-object-default.jpg",default:"assets/default-thumbnail.jpg"},groupHeaderAlignment:"left",groupHeaderPosition:"top",iconSettings:{enableCustomIcons:!1,enableFontAwesome:!1,fontAwesomeUrl:"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css",iconSize:"24px",iconColor:"#3b82f6",iconOpacity:.9,iconAlignment:"left",iconMargin:12,iconBorderRadius:6,enableIconHover:!0,iconHoverScale:1.15,iconHoverOpacity:1,customIcons:{Panorama:"fas fa-home",Hotspot:"fas fa-laptop",Polygon:"fas fa-diamond",Video:"fas fa-video",Webframe:"fas fa-laptop",Image:"fas fa-image",Text:"fas fa-file-alt",ProjectedImage:"fas fa-desktop",Element:"fas fa-circle",Business:"fas fa-building","3DHotspot":"fas fa-gamepad",Container:"fas fa-window-restore","3DModel":"fas fa-cube","3DModelObject":"fas fa-wrench",default:"fas fa-circle"},showIconFor:{panorama:!0,hotspot:!0,polygon:!0,video:!0,webframe:!0,image:!0,text:!0,projectedImage:!0,element:!0,business:!0,"3dmodel":!0,"3dhotspot":!0,"3dmodelobject":!0,container:!0,other:!0},fallbackSettings:{useDefaultOnError:!0,hideIconOnError:!1,showTypeLabel:!1}}},displayLabels:{Panorama:"Panorama",Hotspot:"Hotspot",Polygon:"Polygon",Video:"Video",Webframe:"Webframe",Image:"Image",Text:"Text",ProjectedImage:"Projected Image",Element:"Element",Business:"Business","3DHotspot":"3D Hotspot","3DModel":"3D Model","3DModelObject":"3D Model Object",Container:"Container"},useAsLabel:{subtitles:!0,tags:!0,elementType:!1,parentWithType:!1,customText:"[Unnamed Item]"},includeContent:{containerSearch:{enableContainerSearch:!0,containerNames:[]},elements:{includePanoramas:!0,includeHotspots:!0,includePolygons:!0,includeVideos:!0,includeWebframes:!0,includeImages:!0,includeText:!0,includeProjectedImages:!0,includeElements:!0,includeBusiness:!0,include3DModels:!0,include3DHotspots:!0,include3DModelObjects:!0,includeContainers:!0},searchableProperties:{title:!0,description:!0,subtitle:!0,tags:!0,customProperties:[]}},businessData:{useBusinessData:!1,replaceTourData:!1,includeStandaloneEntries:!1,businessDataFile:"business.json",businessDataDir:"business-data",matchField:"id",businessDataUrl:""},googleSheets:{useGoogleSheetData:!1,includeStandaloneEntries:!1,useAsDataSource:!1,fetchMode:"csv",googleSheetUrl:"https://docs.google.com/spreadsheets/d/e/2PACX-1vQrQ9oy4JjwYAdTG1DKne9cu76PZCrZgtIOCX56sxVoBwRzys36mTqvFMvTE2TB-f-k5yZz_uWwW5Ou/pub?output=csv",useLocalCSV:!1,localCSVFile:"search-data.csv",localCSVDir:"business-data",localCSVUrl:"",csvOptions:{header:!0,skipEmptyLines:!0,dynamicTyping:!0},caching:{enabled:!1,timeoutMinutes:60,storageKey:"tourGoogleSheetsData"},animations:{enabled:!1,duration:{fast:150,normal:250,slow:400},easing:"ease-out",searchBar:{openDuration:300,closeDuration:200,scaleEffect:!0},results:{fadeInDuration:200,slideDistance:8,staggerDelay:30},reducedMotion:{respectPreference:!0,fallbackDuration:80}}}}}clearAllValidationMessages(){try{document.querySelectorAll(".validation-message").forEach(e=>{e.parentNode&&e.parentNode.removeChild(e)}),document.querySelectorAll(".form-input, .toggle-input, .color-input, .range-input, .form-select").forEach(e=>{e.classList.remove("error","valid","warning")}),console.log("ðŸ§¹ All validation messages cleared")}catch(e){console.error("ðŸš¨ Security: Error clearing validation messages:",e)}}}"undefined"!=typeof module&&module.exports?module.exports=ControlPanelCore:window.ControlPanelCore=ControlPanelCore;