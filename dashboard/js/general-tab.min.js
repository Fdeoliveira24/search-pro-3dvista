/* Search Pro v3.1 - Last Update on 10/31/2025 - Race Condition Fix */
class GeneralTabHandler{constructor(){this.core=null,this.tabId="general",this.formUpdateTimeout=null}setCore(e){this.core=e}init(e){try{console.log("ðŸš€ Initializing General tab handler"),this.core.setupFormListeners(e),this.setupMobileOverridesToggle(e),this.setupWidthValidation(e),this.setupRangeInputs(e),this.setupVisibilityBehaviorControls(e),this.setupAdvancedMobileValidation(e),this.core.populateForm(e),this.setupResetButtonHandlers(e),this.validateForm(e),console.log("âœ… General tab handler initialized")}catch(e){console.error("âŒ Error initializing General tab:",e)}}setupMobileOverridesToggle(e=document){try{const t=e.querySelector("#mobileOverridesEnabled"),r=e.querySelector("#mobilePositionGrid");if(!t||!r)return;const a=()=>{t.checked?(r.classList.remove("disabled"),r.querySelectorAll("input").forEach(e=>{e.disabled=!1})):(r.classList.add("disabled"),r.querySelectorAll("input").forEach(e=>{e.disabled=!0}))};t.addEventListener("change",a),a(),console.log("ðŸ“± Mobile overrides toggle setup complete")}catch(e){console.error("ðŸš¨ Security: Error setting up mobile overrides toggle:",e)}}setupWidthValidation(e=document){try{const t=e.querySelectorAll(".width-input");t.forEach(e=>{e.addEventListener("input",e=>{const t=this.core.sanitizeInput(e.target.value);/^\d+(%|px|em|rem|vw)?$/.test(t)||""===t?""!==t?(this.validateWidthOverflow(e.target,t),this.handleWidthChange(e.target)):(e.target.classList.remove("error","warning"),window.clearValidationMessage&&window.clearValidationMessage(e.target.id)):(e.target.classList.add("error"),e.target.classList.remove("valid"),window.showValidationMessage&&window.showValidationMessage(e.target,"error","Enter a valid width (e.g., 350px or 95%)",3e3))}),e.addEventListener("blur",e=>{const t=this.core.sanitizeInput(e.target.value);/^\d+$/.test(t)&&(e.target.value=`${t}px`,this.handleWidthChange(e.target))})}),console.log(`âœ… Enhanced width validation set up for ${t.length} inputs`)}catch(e){console.error("ðŸš¨ Security: Error setting up width validation:",e)}}validateWidthOverflow(e,t){try{e.classList.remove("error","warning"),window.clearValidationMessage&&window.clearValidationMessage(e.id);const r=t.match(/^(\d+(?:\.\d+)?)(px|%|em|rem|vw)?$/);if(!r)return;const a=parseFloat(r[1]),o=r[2]||"";"%"===o?100===a?(e.classList.add("warning"),window.showValidationMessage&&window.showValidationMessage(e,"warning","100% width may overflow on small screens. Consider using 95% or max-width constraints.",4e3)):a>95?(e.classList.add("warning"),window.showValidationMessage&&window.showValidationMessage(e,"warning",`${a}% width may cause overflow. Consider using 95% or less.`,4e3)):e.classList.add("valid"):"px"===o&&a>800?(e.classList.add("warning"),window.showValidationMessage&&window.showValidationMessage(e,"warning",`${a}px may be too wide for mobile devices. Consider using percentages.`,4e3)):e.classList.add("valid")}catch(e){console.error("Error validating width overflow:",e)}}setupVisibilityBehaviorControls(e=document){try{const t=e.querySelector("#visibilityBehavior"),r=e.querySelector("#showOnScroll"),a=e.querySelector("#hideThreshold");if(!t)return;const o=()=>{const e="dynamic"===t.value;r&&(r.disabled=!e,r.closest(".form-group").classList.toggle("disabled",!e)),a&&(a.disabled=!e,a.closest(".form-group").classList.toggle("disabled",!e))};t.addEventListener("change",o),o(),console.log("ðŸ‘ï¸ Visibility behavior controls setup complete")}catch(e){console.error("ðŸš¨ Error setting up visibility behavior controls:",e)}}setupAdvancedMobileValidation(e=document){try{const t=e.querySelector("#mobileBottom");t&&t.addEventListener("input",e=>{const t=this.core.sanitizeInput(e.target.value);"auto"===t||/^\d+(%|px|em|rem|vh)$/.test(t)||""===t?(e.target.classList.remove("error"),e.target.classList.add("valid"),window.clearValidationMessage(e.target.id)):(e.target.classList.add("error"),window.showValidationMessage(e.target,"error","Enter 'auto' or valid CSS value (e.g., 20px, 10%)",3e3))});const r=e.querySelector("#hideThreshold");r&&r.addEventListener("input",e=>{const t=parseInt(e.target.value);t<0||t>500?(e.target.classList.add("error"),window.showValidationMessage(e.target,"warning","Threshold should be between 0-500px for optimal UX",3e3)):(e.target.classList.remove("error"),e.target.classList.add("valid"),window.clearValidationMessage(e.target.id))});const a=e.querySelector("#mobileMaxWidth");a&&a.addEventListener("input",e=>{const t=parseInt(e.target.value);t<200||t>800?(e.target.classList.add("error"),window.showValidationMessage(e.target,"warning","Max width should be between 200-800px for mobile usability",3e3)):(e.target.classList.remove("error"),e.target.classList.add("valid"),window.clearValidationMessage(e.target.id))}),console.log("ðŸ“± Advanced mobile validation setup complete")}catch(e){console.error("ðŸš¨ Error setting up advanced mobile validation:",e)}}handleWidthChange(e){try{const t=this.core.sanitizeInput(e.value),r=e.name||e.id;let a=t;if("string"==typeof t&&t.endsWith("px")){const e=parseInt(t.replace("px",""),10);isNaN(e)||(a=e)}this.core.safeSetNestedProperty(this.core.config,r,a),clearTimeout(this.formUpdateTimeout),this.formUpdateTimeout=setTimeout(()=>{this.applyLivePreview(r,a)},300),console.log(`ðŸ“ Width updated: ${r} = ${a}`)}catch(e){console.error("ðŸš¨ Error handling width change:",e)}}setupRangeInputs(e=document){try{const t=e.querySelectorAll('input[type="range"]');t.forEach(e=>{if(!e.parentNode.querySelector(".range-value")){const t=document.createElement("span");t.className="range-value",t.textContent=e.value,e.parentNode.appendChild(t),e.addEventListener("input",()=>{t.textContent=e.value})}}),console.log(`âœ… Range inputs setup for ${t.length} elements`)}catch(e){console.error("ðŸš¨ Error setting up range inputs:",e)}}validateField(e){try{const t="checkbox"===e.type?e.checked:e.value,r=this.core.sanitizeInput(e.name||e.id,100);let a=!0,o="";switch(a=this.core.validateField(e),r){case"searchBar.placeholder":case"searchPlaceholder":t&&""!==t.trim()?t.length>100&&(a=!1,o="Placeholder text must be 100 characters or less"):(a=!1,o="Placeholder text is required");break;case"mobileBreakpoint":t<320?(a=!1,o="Mobile breakpoint should be at least 320px for device compatibility"):t>1200&&(a=!1,o="Mobile breakpoint should not exceed 1200px");break;case"minSearchChars":case"minSearchLength":t<1?(a=!1,o="Must require at least 1 character"):t>5&&(a=!1,o="Requiring more than 5 characters may hurt usability");break;case"searchBar.width":case"searchWidth":if("string"==typeof t&&t.includes("px")){const e=parseInt(t.replace("px",""));e<200?(a=!1,o="Width should be at least 200px for usability"):e>800&&(a=!1,o="Width should not exceed 800px to avoid layout issues")}else if("string"==typeof t&&t.includes("%")){const e=parseInt(t.replace("%",""));e<10?(a=!1,o="Percentage width should be at least 10%"):e>100&&(a=!1,o="Percentage width cannot exceed 100%")}break;case"elementTriggering.initialDelay":case"initialDelay":t>2e3&&(a=!1,o="Delays over 2 seconds may feel unresponsive");break;case"elementTriggering.maxRetries":case"maxRetries":t>10&&(a=!1,o="Too many retries may cause performance issues");break;case"elementTriggering.baseRetryInterval":case"baseRetryInterval":t<100?(a=!1,o="Base retry interval should be at least 100ms"):t>2e3&&(a=!1,o="Base retry interval over 2 seconds may feel unresponsive");break;case"searchBar.mobileOverrides.breakpoint":case"mobileBreakpointOverride":t<320?(a=!1,o="Mobile breakpoint should be at least 320px"):t>1200&&(a=!1,o="Mobile breakpoint should not exceed 1200px");break;case"searchBar.mobileOverrides.maxWidth":case"mobileMaxWidth":t<200?(a=!1,o="Max width should be at least 200px for usability"):t>800&&(a=!1,o="Max width should not exceed 800px for mobile screens");break;case"searchBar.mobilePosition.bottom":case"mobileBottom":"string"==typeof t&&"auto"!==t&&(/^\d+(%|px|em|rem|vh)$/.test(t)||(a=!1,o="Enter 'auto' or valid CSS value (e.g., 20px, 10%)"));break;case"searchBar.mobileOverrides.visibility.hideThreshold":case"hideThreshold":t<0?(a=!1,o="Hide threshold cannot be negative"):t>500&&(a=!1,o="Hide threshold over 500px may affect usability")}return a?(e.classList.remove("error"),e.classList.add("valid"),"function"==typeof window.clearValidationMessage&&window.clearValidationMessage(e.id)):(e.classList.add("error"),e.classList.remove("valid"),"function"==typeof window.showValidationMessage&&window.showValidationMessage(e,"error",o,5e3),console.log(`âš ï¸ General tab validation: ${r} - ${o}`)),a}catch(e){return console.error("ðŸš¨ Security: Error in General tab field validation:",e),!1}}validateForm(e=document){try{const t=e.querySelectorAll(".form-input, .toggle-input, .range-input, .form-select");let r=!0;return t.forEach(e=>{this.validateField(e)||(r=!1)}),console.log("ðŸ“‹ General tab validation: "+(r?"PASSED":"FAILED")),r}catch(e){return console.error("ðŸš¨ Security: Error validating General tab form:",e),!1}}onFormChange(e){try{this.core.onFormChange(e);const t=e.name||e.id;"minSearchChars"===t&&(this.core.safeSetNestedProperty(this.core.config,"minSearchLength",e.value),console.log(`ðŸ“ Updated minSearchLength to match minSearchChars: ${e.value}`)),"searchBar.mobileOverrides.enabled"!==t&&"mobileOverridesEnabled"!==t||this.setupMobileOverridesToggle(),"searchBar.width"!==t&&"searchWidth"!==t||this.handleWidthChange(e)}catch(e){console.error("ðŸš¨ Security: Error handling General tab form change:",e)}}onFormInput(e){try{this.validateField(e);const t=e.name||e.id;if("searchBar.width"===t||"searchWidth"===t){const t=this.core.sanitizeInput(e.value);/^\d+(%|px|em|rem|vw)?$/.test(t)||""===t?(e.classList.remove("error"),e.classList.add("valid")):(e.classList.add("error"),e.classList.remove("valid"))}if("range"===e.type){const t=e.parentNode.querySelector(".range-value");t&&(t.textContent=e.value)}}catch(e){console.error("ðŸš¨ Security: Error handling General tab form input:",e)}}updateConfigFromForm(e=document){try{e.querySelectorAll("[name]").forEach(e=>{const t=e.getAttribute("name");if(!t)return;let r;"checkbox"===e.type?r=e.checked:"number"===e.type||"range"===e.type?r=""===e.value?null:parseFloat(e.value):(r=e.value,"searchBar.width"===t&&"string"==typeof r&&r.includes("px")&&(r=parseInt(r.replace("px",""))||350)),this.core.safeSetNestedProperty(this.core.config,t,r),"minSearchChars"===t&&this.core.safeSetNestedProperty(this.core.config,"minSearchLength",r)}),console.log("ðŸ“ General tab config updated from form")}catch(e){console.error("ðŸš¨ Security: Error updating config from General tab form:",e)}}applyLivePreview(e,t){try{const r=JSON.parse(JSON.stringify(this.core.config));if(this.core.safeSetNestedProperty(r,e,t),"minSearchChars"===e&&this.core.safeSetNestedProperty(r,"minSearchLength",t),this.core.safeLocalStorageSet("searchProLiveConfig",r),window.parent&&window.parent!==window)try{window.parent.postMessage({type:"searchProConfigPreview",config:r,field:this.core.sanitizeInput(e),value:"string"==typeof t?this.core.sanitizeInput(t):t},"*")}catch(e){console.warn("ðŸš¨ Security: Error posting message to parent:",e)}console.log(`ðŸ”„ General tab live preview: ${e} = ${t}`)}catch(e){console.warn("ðŸš¨ Security: General tab live preview failed:",e)}}resetToDefaults(){try{console.log("ðŸ”„ Resetting General tab to defaults");const e=this.core.getDefaultConfig();this.core.config.autoHide={...e.autoHide},this.core.config.mobileBreakpoint=e.mobileBreakpoint,this.core.config.minSearchChars=e.minSearchChars,this.core.config.minSearchLength=e.minSearchChars,this.core.config.searchBar={...e.searchBar},this.core.config.elementTriggering={...e.elementTriggering};const t=document.getElementById("general-panel");t&&(this.core.populateForm(t),this.setupMobileOverridesToggle(t)),console.log("âœ… General tab reset complete")}catch(e){console.error("ðŸš¨ Security: Error resetting General tab:",e)}}setupResetButtonHandlers(e){try{const t=e.querySelectorAll(".reset-section-button");t.forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const r=e.dataset.section;r&&"general"!==r||(this.resetToDefaults(),this.core&&"function"==typeof this.core.showToast&&this.core.showToast("success","General Settings Reset","General settings restored to defaults"))})}),console.log(`ðŸ”„ Reset button handlers set up for ${t.length} buttons`)}catch(e){console.error("ðŸš¨ Error setting up reset button handlers:",e)}}getConfigSummary(){try{return{tab:"General",sections:{autoHide:this.core.config.autoHide,searchBehavior:{mobileBreakpoint:this.core.config.mobileBreakpoint,minSearchChars:this.core.config.minSearchChars,minSearchLength:this.core.config.minSearchLength},searchBar:this.core.config.searchBar,elementTriggering:this.core.config.elementTriggering}}}catch(e){return console.error("ðŸš¨ Security: Error getting General tab config summary:",e),null}}cleanup(){try{clearTimeout(this.formUpdateTimeout),console.log("ðŸ§¹ General tab handler cleaned up")}catch(e){console.error("ðŸš¨ Security: Error cleaning up General tab:",e)}}}"undefined"!=typeof module&&module.exports?module.exports=GeneralTabHandler:window.GeneralTabHandler=GeneralTabHandler;