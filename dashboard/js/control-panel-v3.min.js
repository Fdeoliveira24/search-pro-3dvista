/* Search Pro v3.1 - Last Update on 10/31/2025 - Race Condition Fix */
function toAssetPath(e){if(!e)return e;const o=String(e).trim();return/^(https?:)?\/\//.test(o)||o.startsWith("/")?o:o.replace(/^\.?\/?search-pro-v3\/assets\//i,"assets/").replace(/^\.?\//,"").replace(/^assets\/+/,"assets/")}function normalizeThumbnailPaths(e){const o=e&&e.thumbnailSettings;return o?(o.defaultImagePath&&(o.defaultImagePath=toAssetPath(o.defaultImagePath)),o.defaultImages&&"object"==typeof o.defaultImages&&Object.keys(o.defaultImages).forEach(e=>{o.defaultImages[e]=toAssetPath(o.defaultImages[e])}),e):e}console.log("üîç CONTROL PANEL DEBUG: control-panel-v3.js file is loading!"),console.log("üîç CONTROL PANEL DEBUG: Check if ControlPanelCore exists:",typeof ControlPanelCore);class SecureSearchProControlPanel{constructor(){this.core=new ControlPanelCore,this.modalSystem=null,this.isApplying=!1,this.isDownloading=!1,this.isLoading=!1,this.isResetting=!1,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>this.init()):this.init()}async init(){try{console.log("========================================"),console.log("üöÄ CONTROL PANEL INIT() CALLED!"),console.log("========================================"),console.log("üöÄ Secure Search Pro Control Panel v2.0.0 initializing..."),console.log("‚è≥ Loading: Initializing modular control panel..."),this.modalSystem=new ModalSystem,console.log("‚úÖ Modal system initialized"),this.checkDependencies(),this.setupEventListeners(),this.addKeyboardShortcuts(),this.setupFABMenu(),console.log("========================================"),console.log("üîß ABOUT TO CALL initializeTabHandlers()"),console.log("========================================"),this.initializeTabHandlers(),document.addEventListener("tabContentLoaded",e=>{this.handleTabContentLoaded(e)}),console.log("üõ°Ô∏è Secure Search Pro Control Panel initialized with modular architecture"),window.controlPanelInitialized||(window.controlPanelInitialized=!0,this.core.showToast("success","Control Panel Ready","Modular configuration interface loaded successfully"))}catch(e){console.error("‚ùå Error initializing control panel:",e),this.core.showToast("error","Initialization Error",this.core.sanitizeInput(e.message))}}initializeTabHandlers(){try{if(console.log("üîß Initializing tab handlers..."),"undefined"!=typeof GeneralTabHandler){const e=new GeneralTabHandler;this.core.registerTabHandler("general",e),console.log("‚úÖ General tab handler registered")}if(console.log("üîç CHECKING: typeof AppearanceTabHandler =",typeof AppearanceTabHandler),"undefined"!=typeof AppearanceTabHandler){console.log("üîç CREATING: AppearanceTabHandler instance...");const e=new AppearanceTabHandler;this.core.registerTabHandler("appearance",e),console.log("‚úÖ Appearance tab handler registered")}else console.error("‚ùå AppearanceTabHandler is undefined - file not loaded!");if("undefined"!=typeof DisplayTabHandler){const e=new DisplayTabHandler;this.core.registerTabHandler("display",e),console.log("‚úÖ Display tab handler registered")}if("undefined"!=typeof ContentTabHandler){const e=new ContentTabHandler;this.core.registerTabHandler("content",e),console.log("‚úÖ Content tab handler registered")}if("undefined"!=typeof FilteringTabHandler){const e=new FilteringTabHandler;this.core.registerTabHandler("filtering",e),console.log("‚úÖ Comprehensive Filtering tab handler registered")}if("undefined"!=typeof DataSourcesTabHandler){const e=new DataSourcesTabHandler;this.core.registerTabHandler("data-sources",e),console.log("‚úÖ Data Sources tab handler registered")}if("undefined"!=typeof AdvancedTabHandler){const e=new AdvancedTabHandler;this.core.registerTabHandler("advanced",e),console.log("‚úÖ Advanced tab handler registered")}if("undefined"!=typeof KnowledgeTabHandler){const e=new KnowledgeTabHandler;this.core.registerTabHandler("management",e),console.log("‚úÖ Knowledge tab handler registered")}console.log(`üéØ ${this.core.tabHandlers.size} tab handlers initialized`)}catch(e){console.error("‚ùå Error initializing tab handlers:",e)}}handleTabContentLoaded(e){try{const{tabId:o,tabPanel:t}=e.detail;console.log(`üö®üö®üö® TAB CONTENT LOADED: ${o} üö®üö®üö®`),console.log("üö® Container:",t);const r=this.core.getTabHandler(o);console.log(`üö® Handler found for ${o}:`,r),r?(console.log(`üö® About to call ${o} handler.init()`),r.init(t),console.log(`‚úÖ ${o} tab handler initialized`)):(console.log(`‚ö†Ô∏è No handler found for ${o}, using core functionality`),this.core.setupFormListeners(t),this.core.populateForm(t),this.validateForm(t)),this.core.clearAllValidationMessages()}catch(e){console.error("‚ùå Error handling tab content loaded:",e)}}checkDependencies(){try{const e=[];if("undefined"==typeof ControlPanelCore)return e.push("Core module not loaded"),console.error("üö® Critical: ControlPanelCore not found"),this.core&&this.core.showToast&&this.core.showToast("error","System Error","Core system components are missing. Please refresh the page."),{warnings:[],errors:e};try{const e=this.getBrowserInfo();console.log(`üîç Browser: ${e.name} ${e.version}`)}catch(e){}return console.log("‚úÖ Core dependencies verified"),{warnings:[],errors:[]}}catch(e){return console.error("üö® Error during dependency check:",e),{warnings:[],errors:[]}}}disableIconFeatures(){try{document.querySelectorAll(".icon-picker, .font-awesome-grid").forEach(e=>{e.style.display="none";const o=document.createElement("div");o.className="warning-message",o.textContent="Icon features disabled - FontAwesome not loaded",e.parentNode.insertBefore(o,e)}),console.log("üö® Icon features disabled due to missing FontAwesome")}catch(e){console.error("üö® Error disabling icon features:",e)}}disableAffectedFeatures(e){try{e.some(e=>e.includes("tab handlers"))&&document.querySelectorAll(".nav-item").forEach(e=>{const o=e.dataset.tab,t=o.charAt(0).toUpperCase()+o.slice(1)+"TabHandler";void 0===window[t]&&(e.disabled=!0,e.classList.add("disabled"),e.title=`${o} tab unavailable - handler not loaded`)}),console.log("üö® Affected features disabled to prevent errors")}catch(e){console.error("üö® Error disabling affected features:",e)}}getBrowserInfo(){const e=navigator.userAgent;let o="unknown",t=0;return e.indexOf("Chrome")>-1?(o="Chrome",t=e.match(/Chrome\/(\d+)/)?.[1]||0):e.indexOf("Firefox")>-1?(o="Firefox",t=e.match(/Firefox\/(\d+)/)?.[1]||0):e.indexOf("Safari")>-1?(o="Safari",t=e.match(/Version\/(\d+)/)?.[1]||0):e.indexOf("Edge")>-1&&(o="Edge",t=e.match(/Edge\/(\d+)/)?.[1]||0),{name:o,version:parseInt(t)}}setupEventListeners(){try{const e=document.getElementById("applySettings");e?(console.log("üîß BUTTON: Apply Settings button found and connected"),e.addEventListener("click",o=>{console.log("üîß BUTTON: Apply Settings clicked!",{isApplying:this.isApplying,buttonDisabled:e.disabled}),this.applySettings()})):console.error("‚ùå BUTTON: Apply Settings button not found!"),document.getElementById("downloadConfig")?.addEventListener("click",()=>this.downloadConfig()),document.getElementById("loadConfig")?.addEventListener("click",()=>this.loadConfig()),document.getElementById("resetAll")?.addEventListener("click",async e=>{e.preventDefault(),await this.resetAll()}),document.getElementById("fileInput")?.addEventListener("change",e=>this.handleFileLoad(e)),console.log("‚úÖ Main event listeners setup successfully")}catch(e){console.error("üö® Security: Error setting up event listeners:",e)}}validateForm(e=document){try{let o=null;if(e instanceof Element&&"function"==typeof e.closest&&(o=e.closest(".tab-panel")),o){const t=o.id.replace("-panel",""),r=this.core.getTabHandler(t);if(r&&"function"==typeof r.validateForm)return r.validateForm(e)}const t=e.querySelectorAll(".form-input, .toggle-input, .color-input, .range-input, .form-select");let r=!0;return t.forEach(e=>{this.core.validateField(e)||(r=!1)}),this.updateButtonStates(r),r}catch(e){return console.error("üö® Security: Error validating form:",e),!1}}validateAllTabs(){try{const e=document.querySelectorAll('.tab-panel[data-loaded="true"]');let o=!0;const t=[];return e.forEach(e=>{const r=e.id.replace("-panel",""),n=this.core.getTabHandler(r);let a=!0;if(n&&"function"==typeof n.validateForm)try{const t=n.validateForm(e);a="object"==typeof t&&null!==t?!0===t.isValid:!0===t,a||(console.warn(`‚ùå Validation failed for tab: ${r} (handler validation)`,t),o=!1)}catch(e){console.error(`üö® Security: Handler validation error for ${r}:`,e),a=!1,o=!1}else try{a=this.validateForm(e),a||(console.warn(`‚ùå Validation failed for tab: ${r} (fallback validation)`),o=!1)}catch(e){console.error(`üö® Security: Fallback validation error for ${r}:`,e),a=!1,o=!1}t.push({tabId:r,isValid:a,hasHandler:!(!n||"function"!=typeof n.validateForm)})}),this.updateButtonStates(o),console.log("üîç All tabs validation: "+(o?"PASSED":"FAILED")),console.log("üìä Validation details:",t),this.lastValidationResults=t,o}catch(e){return console.error("üö® Security: Error validating all tabs:",e),this.updateButtonStates(!1),!1}}updateButtonStates(e){try{const o=document.getElementById("applySettings"),t=document.getElementById("downloadConfig");o&&(o.disabled=!e),t&&(t.disabled=!e),this.updateFABStates(e)}catch(e){console.error("üö® Security: Error updating button states:",e)}}updateFABStates(e){try{document.querySelectorAll(".fab-action").forEach(o=>{"fabApply"!==o.id&&"fabDownload"!==o.id||(o.disabled=!e,o.style.opacity=e?"1":"0.5")})}catch(e){console.error("üö® Security: Error updating FAB states:",e)}}ensureAllTabsLoaded(){return new Promise(e=>{const o=document.querySelectorAll(".nav-item"),t=document.querySelectorAll('.tab-panel[data-loaded="true"]');if(o.length===t.length)return void e(!0);const r=document.querySelector(".nav-item.active"),n=r?r.getAttribute("data-tab"):null;console.log(`‚è≥ Ensuring all tabs are loaded (${t.length}/${o.length})...`);const a=t=>{const i=document.querySelectorAll('.tab-panel[data-loaded="true"]');console.log(`üìù Tab loaded, now ${i.length}/${o.length}`),i.length===o.length&&(document.removeEventListener("tabContentLoaded",a),n&&r&&(console.log(`üîÑ Restoring active tab: ${n}`),r.click()),e(!0))};document.addEventListener("tabContentLoaded",a),o.forEach(e=>{const o=e.getAttribute("data-tab"),t=document.getElementById(`${o}-panel`);t&&!t.hasAttribute("data-loaded")&&(console.log(`üîÑ Triggering load for tab: ${o}`),e.click())}),setTimeout(()=>{document.removeEventListener("tabContentLoaded",a),console.warn("‚ö†Ô∏è Not all tabs could be loaded, proceeding anyway"),n&&r&&(console.log(`üîÑ Restoring active tab after timeout: ${n}`),r.click()),e(!1)},5e3)})}async applySettings(){if(console.log("üîß APPLY SETTINGS: Function called! Race check:",{isApplying:this.isApplying,timestamp:Date.now()}),this.isApplying)console.log("üîß APPLY SETTINGS: Already applying, skipping");else{this.isApplying=!0;try{this.setButtonsLoading(!0),await this.ensureAllTabsLoaded(),console.log("üîß APPLY SETTINGS: Skipping validation temporarily to test functionality"),this.modalSystem.showApplySettingsModal(this.core.config,async()=>{this.core.setLoading(!0,"Applying settings..."),console.log("üîß APPLY: Updating tab-specific configurations before apply");const e=this.core.getTabHandler("display");e&&"function"==typeof e.updateDisplayConfigFromForm?(console.log("üîß APPLY: Calling display tab updateDisplayConfigFromForm"),e.updateDisplayConfigFromForm()):console.log("üö® APPLY: Display tab handler or updateDisplayConfigFromForm method not found");try{if(console.log("üîß APPLY SETTINGS: Starting config update from form"),await this.updateConfigFromForm(),normalizeThumbnailPaths(this.core.config),this.core.config.display&&void 0!==this.core.config.display.showTagsInResults&&(this.core.config.showTagsInResults=this.core.config.display.showTagsInResults),console.log("üîß APPLY SETTINGS: Config updated, current thumbnail settings:",{enableThumbnails:this.core.config.thumbnailSettings?.enableThumbnails,defaultImages:this.core.config.thumbnailSettings?.defaultImages}),!this.core.validateAndSanitizeConfig(this.core.config))throw new Error("Configuration validation failed");console.log("üîß APPLY SETTINGS: About to save config to localStorage:",{configSize:JSON.stringify(this.core.config).length,enableThumbnails:this.core.config.thumbnailSettings?.enableThumbnails,panoramaDefault:this.core.config.thumbnailSettings?.defaultImages?.Panorama,hotspotDefault:this.core.config.thumbnailSettings?.defaultImages?.Hotspot});const e=this.core.safeLocalStorageSet("searchProLiveConfig",this.core.config),o=this.core.safeLocalStorageSet("searchProConfig",this.core.config),t=this.core.safeLocalStorageSet("searchProConfigUpdate",Date.now().toString());if(console.log("üîß APPLY SETTINGS: localStorage save results:",{success1:e,success2:o,success3:t}),!e||!o||!t)throw new Error("Failed to save configuration to localStorage");if(console.log("üîß APPLY SETTINGS: Configuration saved to localStorage successfully"),window.parent&&window.parent!==window)try{window.parent.postMessage({type:"searchProConfigUpdate",config:this.core.config},"*")}catch(e){console.warn("üö® Security: Error posting config update:",e)}this.core.showToast("success","Settings Applied Successfully","Configuration updated and ready to use. Refresh your tour to see the changes."),console.log("‚úÖ Settings applied successfully and securely",this.core.config)}catch(e){console.error("‚ùå Error applying settings:",e),this.modalSystem?this.modalSystem.showErrorModal("Apply Settings",{message:"Failed to apply settings to the tour.",details:this.core.sanitizeInput(e.message)},()=>this.applySettings()):this.core.showToast("error","Apply Failed",this.core.sanitizeInput(e.message))}finally{this.core.setLoading(!1)}},()=>{console.log("Settings apply cancelled by user")})}catch(e){console.error("üö® Security: Error in applySettings:",e),this.core.showToast("error","Security Error","Failed to apply settings due to security validation")}finally{this.isApplying=!1,this.setButtonsLoading(!1)}}}async downloadConfig(){if(!this.isDownloading){this.isDownloading=!0;try{if(this.setButtonsLoading(!0),await this.ensureAllTabsLoaded(),!this.validateAllTabs())return void(this.modalSystem?this.modalSystem.showErrorModal("Validation Failed","Please fix all form errors before downloading configuration."):this.core.showToast("error","Validation Failed","Please fix all errors before downloading"));this.modalSystem.showDownloadConfigModal(this.core.config,async()=>{this.core.setLoading(!0,"Generating config file...");try{if(this.updateConfigFromForm(),normalizeThumbnailPaths(this.core.config),!this.core.validateAndSanitizeConfig(this.core.config))throw new Error("Configuration validation failed");this.core.config.display&&void 0!==this.core.config.display.showTagsInResults&&(this.core.config.showTagsInResults=this.core.config.display.showTagsInResults);const e=JSON.parse(JSON.stringify(this.core.config)),o=e=>this.core.ensureAssetPrefix(e);e.thumbnailSettings&&("string"==typeof e.thumbnailSettings.defaultImagePath&&(e.thumbnailSettings.defaultImagePath=o(e.thumbnailSettings.defaultImagePath)),e.thumbnailSettings.defaultImages&&"object"==typeof e.thumbnailSettings.defaultImages&&Object.keys(e.thumbnailSettings.defaultImages).forEach(t=>{const r=e.thumbnailSettings.defaultImages[t];"string"==typeof r&&(e.thumbnailSettings.defaultImages[t]=o(r))})),e.thumbnails&&("string"==typeof e.thumbnails.defaultPath&&(e.thumbnails.defaultPath=o(e.thumbnails.defaultPath)),e.thumbnails.defaults&&"object"==typeof e.thumbnails.defaults&&Object.keys(e.thumbnails.defaults).forEach(t=>{const r=e.thumbnails.defaults[t];"string"==typeof r&&(e.thumbnails.defaults[t]=o(r))})),e.filter&&e.filter.blacklistedValues&&Object.keys(e.filter).length;const t=`/**\n * Search Pro Configuration\n * Generated on ${(new Date).toLocaleString()}\n * This file can be directly included in your project.\n * \n * IMPORTANT: Do not add auto-apply code to this file.\n * The search engine (search-v3.js) will automatically detect and apply\n * this configuration via its DOMContentLoaded handler.\n * \n * Simply include this file after search-v3.js:\n * <script src="search-pro-v3/search-v3.js"><\/script>\n * <script src="search-pro-v3/config/search-pro-config.js"><\/script>\n */\n\n`+`window.searchProConfig = ${JSON.stringify(e,null,2)};\n\n// Node.js module export compatibility\nif (typeof module !== 'undefined' && module.exports) { module.exports = window.searchProConfig; }\n\n// Configuration loaded - search engine will apply via DOMContentLoaded\nconsole.log('‚úÖ CONFIG FILE: window.searchProConfig defined and ready');\n`;if(t.length>this.core.maxConfigSize)throw new Error("Configuration file too large");const r=new Blob([t],{type:"application/javascript"}),n=URL.createObjectURL(r),a=document.createElement("a");a.href=n,a.download="search-pro-config.js",document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(n),this.core.showToast("success","Configuration Downloaded","JavaScript file saved successfully. Include it directly in your project."),console.log("üì• Config JS file downloaded successfully and securely")}catch(e){console.error("‚ùå Error downloading config:",e),this.modalSystem?this.modalSystem.showErrorModal("Download Failed",this.core.sanitizeInput(e.message)):this.core.showToast("error","Download Failed",this.core.sanitizeInput(e.message))}finally{this.core.setLoading(!1)}},()=>{console.log("Download cancelled by user")})}catch(e){console.error("üö® Security: Error in downloadConfig:",e),this.core.showToast("error","Security Error","Failed to download configuration due to security validation")}finally{this.isDownloading=!1,this.setButtonsLoading(!1)}}}async handleFileLoad(e){try{const o=e.target.files[0];if(!o)return;e.target.value="";const t=this.validateFileUpload(o);if(!t.isValid)return void(this.modalSystem?this.modalSystem.showErrorModal("Configuration Load",{message:t.error,file:this.core.sanitizeInput(o.name),size:`${Math.ceil(o.size/1024)}KB`}):this.core.showToast("error","Load Failed",t.error));this.core.setLoading(!0,"Loading configuration...");try{const e=await this.readFile(o);let t;try{t=this.parseJavaScriptConfig(e)}catch(e){throw new Error(`Invalid JavaScript config file: ${e.message}`)}const r=this.validateConfigurationStructure(t);if(!r.isValid)throw new Error(`Invalid configuration structure: ${r.error}`);if(this.core.config=this.core.safeObjectMerge(this.core.getDefaultConfig(),t),!this.core.validateAndSanitizeConfig(this.core.config))throw new Error("Configuration failed security validation");document.querySelectorAll('.tab-panel[data-loaded="true"]').forEach(e=>{this.core.populateForm(e)}),this.core.showToast("success","Configuration Loaded","Settings imported and applied successfully. All forms have been updated."),console.log("üì§ Config loaded successfully and securely",this.core.config)}catch(e){console.error("‚ùå Error loading config:",e),this.modalSystem?this.modalSystem.showErrorModal("Configuration Load",{message:this.core.sanitizeInput(e.message),file:this.core.sanitizeInput(o.name),size:`${Math.ceil(o.size/1024)}KB`}):this.core.showToast("error","Load Failed",this.core.sanitizeInput(e.message))}finally{this.core.setLoading(!1)}}catch(e){console.error("üö® Security: Error in handleFileLoad:",e),this.core.showToast("error","Security Error","File load failed due to security validation")}}parseJavaScriptConfig(e){try{const o={window:{},module:{exports:{}},console:{log:()=>{},warn:()=>{},error:()=>{}}};new Function("window","module","console",e)(o.window,o.module,o.console);let t=o.window.searchProConfig||o.module.exports;if(!t||"object"!=typeof t)throw new Error("No valid searchProConfig found in JavaScript file");return t}catch(e){throw console.error("üö® Error parsing JavaScript config:",e),new Error(`Failed to parse JavaScript config: ${e.message}`)}}validateFileUpload(e){try{const o=10485760;if(e.size>o)return{isValid:!1,error:"File too large. Maximum size is 10MB."};const t=[".js"],r=e.name.toLowerCase();return t.some(e=>r.endsWith(e))?[/\.exe$/i,/\.bat$/i,/\.cmd$/i,/\.scr$/i,/\.vbs$/i,/\.ps1$/i,/\.php$/i,/\.asp$/i,/\.jsp$/i,/\.py$/i,/\.sh$/i,/\.pl$/i].some(e=>e.test(r))?{isValid:!1,error:"Executable files are not allowed for security reasons."}:{isValid:!0}:{isValid:!1,error:"Invalid file type. Only .js files are supported."}}catch(e){return console.error("üö® Security: Error validating file upload:",e),{isValid:!1,error:"File validation failed due to security error."}}}validateConfigurationStructure(e){try{if(!e||"object"!=typeof e)return{isValid:!1,error:"Configuration must be a valid object"};const o=["searchBar","autoHide"];for(const t of o)if(!(t in e))return{isValid:!1,error:`Missing required property: ${t}`};return{isValid:!0}}catch(e){return console.error("üö® Security: Error validating configuration structure:",e),{isValid:!1,error:"Configuration validation failed due to security error"}}}readFile(e){return new Promise((o,t)=>{try{const r=new FileReader;r.onload=e=>{try{const r=e.target.result;if("string"!=typeof r)return void t(new Error("File content is not valid text"));if(r.length>this.core.maxConfigSize)return void t(new Error("File content is too large"));o(r)}catch(e){t(new Error("Failed to read file content"))}},r.onerror=()=>t(new Error("File reading failed")),r.readAsText(e)}catch(e){t(new Error("Failed to initialize file reader"))}})}async updateConfigFromForm(){try{const e=JSON.parse(JSON.stringify(this.core.config));console.log("üìù UPDATE CONFIG: Starting comprehensive config update from all tabs"),await this.ensureAllTabsLoaded(),document.querySelectorAll("[name]").forEach(e=>{const o=e.getAttribute("name");if(!o||!this.core.isValidPropertyName(o))return void console.warn(`üö® Security: Invalid property name: ${o}`);let t;"checkbox"===e.type?t=e.checked:"number"===e.type||"range"===e.type?t=""===e.value?null:parseFloat(e.value):(t=this.core.sanitizeInput(e.value),"searchBar.width"===o&&"string"==typeof t&&t.includes("px")&&(t=parseInt(t.replace("px",""))||350)),this.core.safeSetNestedProperty(this.core.config,o,t)});const o=[];["general","appearance","display","content","filtering","data-sources","advanced","management"].forEach(e=>{const t=this.core.getTabHandler(e),r=document.getElementById(`${e}-panel`);if(t&&"function"==typeof t.updateConfigFromForm)try{const n=JSON.parse(JSON.stringify(this.core.config));t.updateConfigFromForm(r);const a=JSON.parse(JSON.stringify(this.core.config)),i=JSON.stringify(n)!==JSON.stringify(a);o.push({tabId:e,success:!0,configChanged:i}),i?console.log(`üìù Tab-specific config update for ${e} completed with changes`):console.log(`üìù Tab-specific config update for ${e} completed (no changes)`)}catch(t){console.error(`‚ùå Error updating config for ${e} tab:`,t),o.push({tabId:e,success:!1,error:t.message})}else console.warn(`‚ö†Ô∏è No handler or updateConfigFromForm method found for ${e} tab`),o.push({tabId:e,success:!1,error:"No handler available"})});const t=o.filter(e=>e.success),r=o.filter(e=>!e.success),n=o.filter(e=>e.success&&e.configChanged);if(console.log(`üìä Config update summary: ${t.length} successful, ${r.length} failed, ${n.length} with changes`),t.length>0&&console.log("‚úÖ Successful tabs:",t.map(e=>e.tabId).join(", ")),n.length>0&&console.log("üîÑ Tabs with changes:",n.map(e=>e.tabId).join(", ")),r.length>0&&console.warn("‚ùå Failed tabs:",r.map(e=>`${e.tabId} (${e.error})`).join(", ")),!this.core.validateAndSanitizeConfig(this.core.config))throw console.warn("‚ö†Ô∏è Final configuration failed validation, reverting to backup"),this.core.config=e,new Error("Final configuration validation failed");console.log("‚úÖ updateConfigFromForm completed successfully")}catch(e){throw console.error("üö® Security: Error updating config from form:",e),this.core.config=configBackup,new Error("Failed to update configuration from form: "+e.message)}}getDetailedValidationResults(){if(!this.lastValidationResults)return"No detailed validation results available";const e=this.lastValidationResults.filter(e=>!e.isValid);return 0===e.length?"All tabs passed validation":e.map(e=>`${e.tabId}: Failed ${e.hasHandler?"handler":"fallback"} validation`).join(", ")}async resetAll(){if(this.isResetting)console.log("‚ö†Ô∏è Reset already in progress, skipping...");else{this.isResetting=!0;try{console.log("üîÑ Starting reset process..."),this.setButtonsLoading(!0),this.modalSystem?this.modalSystem.showResetAllModal(async()=>{console.log("‚úÖ Reset confirmed by user");try{await this.performCompleteReset()}catch(e){console.error("‚ùå Error during reset:",e)}finally{this.isResetting=!1,this.setButtonsLoading(!1)}},()=>{console.log("‚ùå Reset cancelled by user"),this.isResetting=!1,this.setButtonsLoading(!1)}):(confirm("Are you sure you want to reset all settings to default values? This action cannot be undone.")?(console.log("‚úÖ Reset confirmed by user (browser dialog)"),await this.performCompleteReset()):console.log("‚ùå Reset cancelled by user (browser dialog)"),this.isResetting=!1,this.setButtonsLoading(!1))}catch(e){console.error("üö® Security: Error in resetAll:",e),this.isResetting=!1,this.setButtonsLoading(!1)}}}async performCompleteReset(){this.core.setLoading(!0,"Resetting all settings...");try{console.log("üîÑ Starting complete reset process..."),this.core.clearAllValidationMessages(),this.core.config=this.core.getDefaultConfig(),console.log("‚úÖ Configuration reset to defaults"),this.core.tabHandlers.forEach((e,o)=>{"function"==typeof e.resetToDefaults&&(e.resetToDefaults(),console.log(`‚úÖ ${o} tab reset to defaults`))}),document.querySelectorAll('.tab-panel[data-loaded="true"]').forEach(e=>{this.core.populateForm(e)}),console.log("‚úÖ Form fields reset"),this.clearStorageEntries(),console.log("‚úÖ Storage cleared"),this.updateButtonStates(!0),console.log("‚úÖ Button states updated"),this.core.showToast("success","Settings Reset Complete","All settings have been restored to their default values. All forms have been updated with the new configuration."),console.log("üéâ Complete reset process finished successfully")}catch(e){console.error("‚ùå Error during reset process:",e),this.handleResetError(e)}finally{this.core.setLoading(!1)}}clearStorageEntries(){try{["searchProConfig","searchProLiveConfig","searchProSettings","controlPanelState","sidebarCollapsed","currentTab","lastAppliedConfig","configBackup"].forEach(e=>{try{localStorage.removeItem(e),sessionStorage.removeItem(e)}catch(o){console.warn(`Could not clear storage key: ${e}`,o)}}),console.log("üóÑÔ∏è Storage entries cleared")}catch(e){console.error("üö® Security: Error clearing storage entries:",e)}}handleResetError(e){try{this.modalSystem?this.modalSystem.showErrorModal("Reset Failed",{message:"An error occurred while resetting settings.",details:this.core.sanitizeInput(e.message)},()=>{this.performCompleteReset()}):this.core.showToast("error","Reset Failed",this.core.sanitizeInput(e.message))}catch(e){console.error("üö® Security: Error handling reset error:",e)}}handleKeyboardShortcuts(e){try{if((e.ctrlKey||e.metaKey)&&"s"===e.key)return e.preventDefault(),void this.applySettings();if((e.ctrlKey||e.metaKey)&&"d"===e.key)return e.preventDefault(),void this.downloadConfig();if((e.ctrlKey||e.metaKey)&&"l"===e.key)return e.preventDefault(),void this.loadConfig();if((e.ctrlKey||e.metaKey)&&"r"===e.key)return e.preventDefault(),void this.resetAll();"Escape"===e.key&&this.modalSystem&&this.modalSystem.closeModal()}catch(e){console.error("üö® Security: Error handling keyboard shortcuts:",e)}}addKeyboardShortcuts(){try{document.addEventListener("keydown",e=>this.handleKeyboardShortcuts(e))}catch(e){console.error("üö® Security: Error adding keyboard shortcuts:",e)}}async loadConfig(){try{const e=document.getElementById("fileInput");e&&e.click()}catch(e){console.error("üö® Security: Error loading config:",e)}}setButtonsLoading(e){try{[document.getElementById("applySettings"),document.getElementById("downloadConfig"),document.getElementById("loadConfig"),document.getElementById("resetAll")].forEach(o=>{o&&(o.disabled=e,e?(o.style.opacity="0.6",o.style.cursor="not-allowed"):(o.style.opacity="1",o.style.cursor="pointer"))}),document.querySelectorAll(".fab-action").forEach(o=>{o&&(o.disabled=e,o.style.opacity=e?"0.6":"1")})}catch(e){console.error("üö® Error setting buttons loading state:",e)}}setupFABMenu(){try{console.log("üéØ FAB Menu integration ready"),window.fabMenu&&"function"==typeof window.fabMenu.setControlPanel?(window.fabMenu.setControlPanel(this),console.log("‚úÖ FAB Menu connected to control panel")):console.log("‚ÑπÔ∏è FAB Menu does not require control panel connection")}catch(e){console.error("üö® Security: Error setting up FAB menu:",e)}}}class SearchProControlPanel extends SecureSearchProControlPanel{constructor(){super(),console.log("üõ°Ô∏è Secure Search Pro Control Panel initialized with modular architecture and comprehensive protection")}}let lastErrorTime=0,errorCount=0;const ERROR_THROTTLE_DELAY=5e3;window.addEventListener("error",e=>{console.error("üö® Control Panel Error:",e.error);const o=Date.now();if(o-lastErrorTime<5e3)errorCount++;else if(e.error&&("ReferenceError"===e.error.name&&e.error.message.includes("not defined")||"TypeError"===e.error.name&&e.error.message.includes("Cannot read properties of null"))&&window.searchProControlPanel&&window.searchProControlPanel.core&&"function"==typeof window.searchProControlPanel.core.showToast){lastErrorTime=o;const e=errorCount>0?`Script issue detected (${errorCount+1} errors). Some features may not work.`:"A script issue was detected. Most features should continue working.";window.searchProControlPanel.core.showToast("warning","Script Warning",e),errorCount=0}}),window.addEventListener("unhandledrejection",e=>{console.error("üö® Unhandled Promise Rejection:",e.reason);const o=Date.now();o-lastErrorTime<5e3||e.reason&&(e.reason.message?.includes("Failed to fetch")||e.reason.message?.includes("Network error")||e.reason.message?.includes("Critical"))&&window.searchProControlPanel&&window.searchProControlPanel.core&&"function"==typeof window.searchProControlPanel.core.showToast&&(lastErrorTime=o,window.searchProControlPanel.core.showToast("warning","Network Warning","A network issue occurred. Some features may be limited."))}),document.addEventListener("DOMContentLoaded",()=>{console.log("üõ°Ô∏è Modular Secure Control Panel System loaded with the following protections:"),console.log("  ‚úÖ Modular architecture with tab handlers"),console.log("  ‚úÖ Prototype pollution prevention"),console.log("  ‚úÖ Safe object merging and property setting"),console.log("  ‚úÖ Input sanitization for all user data"),console.log("  ‚úÖ Secure localStorage operations"),console.log("  ‚úÖ Configuration validation and filtering"),console.log("  ‚úÖ XSS prevention in form handling"),console.log("  ‚úÖ File upload security validation"),console.log("  ‚úÖ Memory leak prevention"),console.log("  ‚úÖ Property name validation"),console.log("  ‚úÖ Content safety validation"),console.log("  ‚úÖ Error boundary implementation"),console.log("  ‚úÖ Tab-specific validation and handling"),console.log("  ‚úÖ Modular live preview system"),console.log("  ‚úÖ Enhanced security logging")}),console.log("========================================"),console.log("üî• CREATING CONTROL PANEL INSTANCE..."),console.log("========================================"),window.searchProControlPanel=new SecureSearchProControlPanel,console.log("========================================"),console.log("üî• CONTROL PANEL INSTANCE CREATED!"),console.log("========================================");